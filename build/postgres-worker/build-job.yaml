apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-worker-build
  namespace: default
spec:
  # PURPOSE:
  #   Orchestrates the build process for the Postgres Worker image.
  #   This is distinct from the Coordinator build to allow for independent
  #   scaling or versioning strategies in the future, even if they currently share the Dockerfile.

  # WHY:
  #   Using a K8s Job ensures the build happens in a clean, isolated environment
  #   inside the cluster, without polluting the host node or requiring external CI runners.
  backoffLimit: 0 # Fail immediately on error; do not retry a broken build.
  completions: 1
  parallelism: 1
  template:
    spec:
      containers:
        - name: kaniko
          image: gcr.io/kaniko-project/executor:latest
          args:
            - --force
            - --context=/workspace
            # REUSE:
            #   We reuse the generic 'docker/postgres/Dockerfile'.
            #   The differentiation happens via build arguments (not used here heavily yet)
            #   or runtime configuration injected later by Helm.
            - --dockerfile=docker/postgres/Dockerfile
            - --destination=$(REGISTRY_URL)/$(POSTGRES_BUILT_IMAGE)
            - --build-arg=POSTGRES_PORT=$(POSTGRES_PORT)
            - --build-arg=IMAGE_FROM_REGISTRY=$(REGISTRY_URL)/$(POSTGRES_BUILT_IMAGE)
            - --insecure
            - --skip-tls-verify
          securityContext:
            # RISKS:
            #   Running as root with privileges is dangerous but currently necessary
            #   for Kaniko to manipulate the container filesystem and push layers.
            runAsUser: 0
            privileged: true
          volumeMounts:
            - name: workspace
              mountPath: /workspace
          workingDir: /workspace
          envFrom:
            # DEPENDENCY:
            #   Loads the 'postgres-config' ConfigMap.
            #   This ensures the worker build uses the exact same version/tag definitions
            #   as the runtime environment.
            - configMapRef:
                name: postgres-config
          env:
            - name: REGISTRY_URL
              value: "registry.default.svc.cluster.local:5000"
            - name: POSTGRES_BUILT_IMAGE
              valueFrom:
                configMapKeyRef:
                  name: postgres-config
                  key: POSTGRES_BUILT_IMAGE
      restartPolicy: Never
      volumes:
        - name: workspace
          hostPath:
            # CONSTRAINT:
            #   Direct host path mounting implies this Job must run on the node
            #   where the source code was copied (Minikube single-node assumption).
            path: /workspace
            type: Directory
