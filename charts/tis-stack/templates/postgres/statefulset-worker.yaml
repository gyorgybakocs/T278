{{- if and .Values.postgres.enabled (not .Values.global.onlyConfig) -}}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "tis-stack.fullname" . }}-postgres-worker
  labels:
    {{- include "tis-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgres-worker
spec:
  # NETWORK IDENTITY:
  #   Points to the Headless Service created previously.
  #   WHY: This generates stable DNS names for each pod (e.g., worker-0, worker-1).
  #   The Coordinator relies on these fixed names to register the nodes.
  #   If we used a Deployment, pod names would be random hashes, breaking registration after restarts.
  serviceName: "postgres-worker-headless"

  # SCALING:
  #   Defined in values.yaml (default: 3).
  #   RISK: Scaling down (reducing replicas) is DESTRUCTIVE in Citus.
  #   It requires manually moving shards off the node before deletion,
  #   otherwise data is lost. Automatic scaling is not safe here.
  replicas: {{ .Values.postgres.worker.replicas }}
  selector:
    matchLabels:
      {{- include "tis-stack.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: postgres-worker
  template:
    metadata:
      labels:
        {{- include "tis-stack.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: postgres-worker
    spec:
      securityContext:
        {{- toYaml .Values.postgres.podSecurityContext | nindent 8 }}
      containers:
        - name: postgres
          image: "{{ .Values.global.registry }}/{{ .Values.postgres.image.repository }}:{{ .Values.postgres.image.tag }}"
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}

          envFrom:
            - configMapRef:
                name: postgres-config
            - configMapRef:
                name: global-config

          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tis-app-secrets
                  key: postgres-password

            # DATA INTEGRITY:
            #   Using a subdirectory fixes "Permission Denied" errors on some cloud providers (e.g., AWS EBS),
            #   where the persistent volume root is owned by root, but Postgres runs as uid 999.
            #   The 'lost+found' directory at root can also cause initdb failures.
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata

            # ROLE DEFINITION:
            #   We explicitly set this to "0".
            #   WHY: Worker nodes are passive participants. They do not run the registration logic
            #   or wait for other nodes. They simply start up and wait to be called by the Coordinator.
            - name: PG_WORKER_REPLICAS
              value: "0"

            # RESOURCE TUNING:
            #   Workers share the same tuning configs as the coordinator (from ConfigMap),
            #   but they are the ones actually using the memory for large joins/aggregations.
            - name: PG_MAX_CONNECTIONS
              value: {{ .Values.postgres.config.max_connections | quote }}
            - name: PG_SHARED_BUFFERS
              value: {{ .Values.postgres.config.shared_buffers | quote }}
            - name: PG_WORK_MEM
              value: {{ .Values.postgres.config.work_mem | quote }}
            - name: PG_MAINTENANCE_WORK_MEM
              value: {{ .Values.postgres.config.maintenance_work_mem | quote }}
            - name: PG_EFFECTIVE_CACHE_SIZE
              value: {{ .Values.postgres.config.effective_cache_size | quote }}
            - name: PG_MAX_WORKER_PROCESSES
              value: {{ .Values.postgres.config.max_worker_processes | quote }}
            - name: PG_MAX_PARALLEL_WORKERS
              value: {{ .Values.postgres.config.max_parallel_workers | quote }}
            - name: PG_MAX_PREPARED_TRANSACTIONS
              value: {{ .Values.postgres.config.max_prepared_transactions | quote }}

          ports:
            - containerPort: 5432
              name: postgres

          resources:
            {{- toYaml .Values.postgres.worker.resources | nindent 12 }}

          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data

  # STORAGE:
  #   'volumeClaimTemplates' dynamically creates a unique PersistentVolumeClaim (PVC)
  #   for EACH replica (data-worker-0, data-worker-1, etc.).
  #   This ensures that if a pod crashes and reschedules, it reattaches to ITS OWN specific data.
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: {{ .Values.global.storageClass }}
        resources:
          requests:
            storage: {{ .Values.postgres.worker.persistence.size }}
{{- end }}
